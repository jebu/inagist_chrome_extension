<html>
<head>
<script type="text/javascript" src="lib/3rdparty/jquery.js"></script>
<script type="text/javascript" src="lib/options.js"></script>
<script type="text/javascript" src="lib/utils.js"></script>
<script>
function log(Message){
  if (Options.getBoolean("debug"))
    console.log(Message);
}

function show(message, image, title) {
  title = title ? title : "inagist.com";
  image = image ? image : 'img/inagist48.png';
  var notification = webkitNotifications.createNotification(
    image,                      // The image.
    title, // The title.
    message      // The body.
  );
  notification.show();
  if (Options.get("autoClose")) {
    var closeTimer = setTimeout(function() {
      notification.cancel();
    }, Options.get("alertTimeout"));
    notification.onclick = function() {
      clearTimeout(closeTimer)
    };
  }
}

function showHtml() {
  var notification = webkitNotifications.createHTMLNotification(
    'tweets_notifier.html'
  );
  if (Options.get("autoClose")) {
    var closeTimer = setTimeout(function() {
      notification.cancel();
    }, Options.get("alertTimeout"));
    notification.onclick = function() {
      clearTimeout(closeTimer)
    };
  }
  notification.show();
}

function iconAlert(Color, Text) {
  chrome.browserAction.setBadgeBackgroundColor({color: Color});
  chrome.browserAction.setBadgeText({text: Text});
}

function setToolTip(Text) {
  chrome.browserAction.setTitle({title: Text});
}

function sendSearch(Text) {
  if ((ws.readyState == ws.OPEN) && Text && (Text.trim().length > 0)) {
    log("Sending search terms " + Text.trim());
    ws.send("search " + Text.trim());
  }
}

function trimElement(element) {
  return element.trim();
}

function sendSearchTerms() {
  var searchTerms = Options.get("searchText").split(",").map(trimElement);
  var ignoredTerms = [];
  
  if (Options.get("ignoredTerms"))
    ignoredTerms = Options.get("ignoredTerms").split(",").map(trimElement);

  if (Options.get("autoTrackTrends") === true || Options.get("autoTrackTrends") == "true") {
    for (i in autoTracked) {
      if (($.inArray(autoTracked[i], searchTerms) < 0) && ($.inArray(autoTracked[i], ignoredTerms) < 0))
        searchTerms.push(autoTracked[i]);
    }
  }
  
  if (Options.get("autoTrackChannelTrends") === true || Options.get("autoTrackChannelTrends") == "true") {
    for (i in autoTrackedChannel) {
      if (($.inArray(autoTrackedChannel[i], searchTerms) < 0) && ($.inArray(autoTrackedChannel[i], ignoredTerms) < 0))
        searchTerms.push(autoTrackedChannel[i]);
    }
  }

  var text = searchTerms.slice(0, 20).join(",");
  sendSearch(text);
}

function connect() {
  if ("WebSocket" in window) {
    ws = new WebSocket(Options.get("websocketURL"));
    
    ws.onopen = function() {
      // Web Socket is connected. You can send data by send() method.
      ws.send("stream " + connectedUser);
      if (Options.get("autoTrackTrends"))
        ws.send("trackwords " + connectedUser);
      else
        sendSearchTerms();
      ws.send("setlimit tweet_archived_limit " + Options.get("tweet_archived_limit"));
    };

    ws.onmessage = function (evt)
    {
      var data = evt.data;
      var eventObj = JSON.parse(data);
      log(data);
      if (eventObj.error){
        show("Error " + eventObj.error);
      } else if (eventObj.status == "connected") {
        iconAlert([10, 200, 10, 228], "On");
        setToolTip("inagist.com - " + connectedUser);
      } else if (eventObj.trackwords) {
        var trackwords = eventObj.trackwords.map(trimElement);
        for (i in trackwords) {
          if ($.inArray(trackwords[i], autoTracked) < 0) {
            autoTracked.push(trackwords[i]); 
          }
        }
        sendSearchTerms();
      } else if (eventObj.trending_personal_phrase) {
        var corelationText = " trend " + eventObj.trending_personal_phrase.phrase + 
                             " for you";
        if ($.inArray(eventObj.trending_personal_phrase.phrase, autoTracked) < 0) {
          autoTracked.push(eventObj.trending_personal_phrase.phrase); 
          if (Options.get("autoTrackTrends") === true || Options.get("autoTrackTrends") == "true")
            sendSearchTerms();
        }
        ws.send("tweet " + eventObj.trending_personal_phrase.id_str + corelationText);
      } else if (eventObj.trending_channel_phrase) {
        var corelationText = " trend " + eventObj.trending_channel_phrase.phrase + 
                             " in " + eventObj.trending_channel_phrase.channel;
        if ($.inArray(eventObj.trending_channel_phrase.phrase, autoTrackedChannel) < 0) {
          autoTrackedChannel.push(eventObj.trending_channel_phrase.phrase); 
          if (Options.get("autoTrackChannelTrends") === true || Options.get("autoTrackChannelTrends") == "true")
            sendSearchTerms();
        }
        ws.send("tweet " + eventObj.trending_channel_phrase.id_str + corelationText);
      } else if (eventObj.tweet_archived) {
        var tweet = eventObj.tweet_archived;
        ws.send("tweet " + tweet.id_str);
      } else if (eventObj.lookedup_url) {
        if (eventObj.lookedup_url.title && eventObj.lookedup_url.description) {
          notificationQueue.push(eventObj);
          showHtml();
        }
      } else if (eventObj.lookedup_tweet) {
        notificationQueue.push(eventObj);
        showHtml();
      } else if (eventObj.search_result) {
        if (eventObj.search_result.ids) {
          for (var i in eventObj.search_result.ids) {
            ws.send("tweet " + eventObj.search_result.ids[i]);
          }
        } else {
          var corelationText = "";
          if (eventObj.search_result.text)
            corelationText = " match " + eventObj.search_result.text;
          ws.send("tweet " + eventObj.search_result.id_str + corelationText );
        }
      }
    };

    ws.onclose = function()
    {
      iconAlert([200, 10, 10, 228], "Off");
      setToolTip("inagist.com");
    };

    ws.onerror = function() {
      // reconnect on error
      reConnect();
    };

  } else {
    show("You have no web sockets");
  };
}

function disconnect() {
  if (ws.readyState === ws.OPEN)
    ws.close();
}

function toggleConnection() {
  if (ws.readyState === ws.CLOSED) {
    connectedUser = Options.get("userid");
    if (connectedUser && connectedUser.trim().length > 0)
      connect();
  } else {
    disconnect();
  }
}

function reConnect() {
  disconnect();
  toggleConnection();
}

Options.init();
chrome.idle.onStateChanged.addListener(function(newState){
  console.log("State changed to " + newState);
});

var notificationQueue = [];
var ws = null;
var connectedUser = Options.get("userid");
var autoTracked = [];
var autoTrackedChannel = [];

chrome.browserAction.onClicked.addListener(toggleConnection);
iconAlert([200, 10, 10, 228], "Off");
if (connectedUser)
  connect();
</script>
</head>
<body>
   <script>
     var _gaq = _gaq || [];
     _gaq.push(['_setAccount', 'UA-16053252-4']);
     _gaq.push(['_trackPageview']);

     (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = 'https://ssl.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();
   </script>
</body>
</html>
